#! /usr/bin/env python

import os
import sys
import argparse
import unittest

from squidsa.bench import bench
from squidsa import settings

def recurseIterSuite(suite, match, pattern):
    for s in suite:
        if isinstance(s, unittest.TestCase):
            if pattern in s._testMethodName:
                match.addTest(s)
        else:
            recurseIterSuite(s, match, pattern)


def createTestSuite(test):
    """
    Create a test suite. The parameter will be tested in the following order
    and the matching tests will be loaded:
      - "all", all tests found under the test/ directory will be loaded.
      - a filename under test/. Every test in that file will be loaded.
      - a string. Test methodes containing that string will be loaded.
    """
    loader = unittest.TestLoader()

    if test == 'all':
        return loader.discover(start_dir="squidsa.test", pattern="*.py")

    # load test matching the filename, and let's see how many it gets
    if test.endswith(".py"):
        suite = loader.discover(start_dir="squidsa.test", pattern=test)
        if suite.countTestCases() != 0:
            return suite

    # load every tests we can find and do some matching based on that
    suite = loader.discover(start_dir="squidsa.test", pattern="*.py")
    matching_suite = unittest.TestSuite()
    recurseIterSuite(suite, matching_suite, test)

    return matching_suite


def main(bench_conf, test_name, dry_run):
    bench.setup(bench_conf)
    incomplete_links = bench.incomplete_links

    for l in incomplete_links:
        print("Link {} is not connected to both ends".format(l))

    suite = createTestSuite(test_name)
    runner = unittest.TextTestRunner()

    print("-"*70)

    bench.connect(dry_run)
    runner.run(suite)
    bench.disconnect(dry_run)


if __name__ == "__main__":
    parser = argparse.ArgumentParser(description='Control a DSA test bench')
    parser.add_argument('-t', '--test', default='all',
                        help='select tests to be executed (default: \"all\"')
    parser.add_argument('-C', '--conf-dir', default=None,
                        help='path to the configuration directory')
    parser.add_argument('--dry-run', action='store_true', default=False,
                        help='Skip connection to the test bench (no SSHing is done)')
    parser.add_argument('bench_conf', help='Bench configuration')
    args = parser.parse_args()

    if args.conf_dir is not None:
        path = os.path.join(os.getcwd(), args.conf_dir)
        settings.set(settings.CONF_PATH, os.path.realpath(path))

    main(args.bench_conf, args.test, args.dry_run)
